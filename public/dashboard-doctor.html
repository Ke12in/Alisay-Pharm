<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Doctor Dashboard - Alisay Medical Center</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.css" rel="stylesheet">
  <style>
    html, body { height: 100%; }
    body {
      min-height: 100vh;
      height: 100%;
      width: 100%;
      background: linear-gradient(135deg, #e0eafc 0%, #cfdef3 100%);
      display: flex;
      flex-direction: column;
    }
    main {
      flex: 1 0 auto;
      display: flex;
      align-items: center;
      justify-content: center;
      min-height: 80vh;
      width:100%;
    }
    .fade-in {
      opacity: 0;
      transform: translateY(30px);
      animation: fadeInUp 1s ease-out 0.2s forwards;
    }
    @keyframes fadeInUp {
      to { opacity: 1; transform: none; }
    }
    .card {
      border: none;
      border-radius: 1.5rem;
      box-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
      transition: box-shadow 0.3s cubic-bezier(.4,2,.6,1), transform 0.3s cubic-bezier(.4,2,.6,1);
      background: #fff;
    }
    .card:hover {
      box-shadow: 0 16px 48px 0 rgba(31, 38, 135, 0.25);
      transform: translateY(-4px) scale(1.01);
    }
    .logo {
      width: 60px;
      height: 60px;
      object-fit: contain;
      margin-bottom: 1rem;
    }
    .btn-logout {
      /* No longer needed for height, handled by .btn-lg-custom */
    }
    .btn-lg-custom {
      padding-top: 0.6rem;
      padding-bottom: 0.6rem;
      font-size: 1.1rem;
      min-width: 140px;
    }
    footer { flex-shrink: 0; }
    .content-area { flex: 1 1 auto; padding: 2rem; background: transparent; min-height: 0; }
    .sidebar-mobile-overlay { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.3); z-index: 1999; }
    .sidebar-mobile-overlay.active { display: block; }
    .sidebar-mobile { position: fixed; top: 0; left: 0; width: 220px; height: 100vh; background: #1a237e; color: #fff; display: flex; flex-direction: column; padding: 2rem 1rem 1rem 1rem; box-shadow: 2px 0 8px rgba(31,38,135,0.08); z-index: 2000; transition: transform 0.3s ease; transform: translateX(-100%); }
    .sidebar-mobile.show { transform: translateX(0); }
    .sidebar-toggle-btn { display: none; }
    /* Increase table width and improve button spacing */
    .table-responsive { min-width: 1200px; }
    .action-buttons { display: flex; gap: 0.25rem; flex-wrap: wrap; }
    .action-buttons .btn { font-size: 0.75rem; padding: 0.25rem 0.5rem; }
    .modal { z-index: 1055; }
    .modal-backdrop { z-index: 1050; }
  </style>
</head>
<body>
  <main>
    <div class="card p-4 fade-in position-relative" style="max-width: 520px; width: 100%;">
      <button class="btn btn-outline-danger btn-sm position-absolute" id="logoutBtn" style="top: 1.5rem; right: 1.5rem; z-index: 10;"><i class="fa-solid fa-sign-out-alt"></i> Logout</button>
      <div class="text-center">
        <img src="https://img.icons8.com/ios-filled/100/4a90e2/hospital-room.png" alt="Logo" class="logo mb-2">
        <h2 class="mb-2">Welcome, Doctor!</h2>
        <p class="text-muted mb-4">View your appointments and manage patient records.</p>
      </div>
      <div class="topbar">
        <div class="d-flex align-items-center gap-3">
          <div class="dropdown">
            <button class="btn btn-outline-primary position-relative" type="button" id="notificationsDropdown" data-bs-toggle="dropdown" aria-expanded="false" title="Notifications">
              <i class="fa-solid fa-bell"></i>
              <span class="position-absolute top-0 start-100 translate-middle badge rounded-pill bg-danger" id="notificationBadge" style="display: none;">
                0
              </span>
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="notificationsDropdown" style="width: 300px;">
              <li><h6 class="dropdown-header">Notifications</h6></li>
              <li><hr class="dropdown-divider"></li>
              <div id="notificationsList">
                <li class="px-3 py-2 text-muted">No new notifications</li>
              </div>
            </ul>
          </div>
          <div class="profile" id="doctor-profile-link">
            <span id="doctor-name" class="fw-bold text-primary">Doctor</span>
          </div>
        </div>
      </div>
      <div id="appointments-section">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5>Appointments</h5>
          <div class="d-flex gap-2">
            <button class="btn btn-outline-secondary" id="calendarViewBtn" title="Toggle Calendar View" data-bs-toggle="tooltip"><i class="fa-solid fa-calendar-days"></i></button>
            <button class="btn btn-outline-success" id="exportCsvBtn" title="Export to CSV" data-bs-toggle="tooltip"><i class="fa-solid fa-file-csv"></i></button>
          </div>
        </div>
        <div id="tableViewContainer">
          <ul class="nav nav-tabs mb-2" id="apptTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="today-tab" data-bs-toggle="tab" data-bs-target="#today" type="button" role="tab">Today</button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="upcoming-tab" data-bs-toggle="tab" data-bs-target="#upcoming" type="button" role="tab">Upcoming</button>
            </li>
          </ul>
          <div class="d-flex mb-2 gap-2 align-items-center">
            <select class="form-select w-auto" id="statusFilter" title="Filter by status">
              <option value="">All Statuses</option>
              <option value="pending">Pending</option>
              <option value="approved">Approved</option>
              <option value="rejected">Rejected</option>
              <option value="completed">Completed</option>
            </select>
            <input type="text" class="form-control w-auto" id="searchInput" placeholder="Search patient/service..." style="max-width:220px;">
          </div>
          <div class="tab-content">
            <div class="tab-pane fade show active" id="today" role="tabpanel">
              <div class="table-responsive mb-3">
                <table class="table table-hover align-middle" id="doctor-appointments-table-today">
                  <thead class="table-light sticky-top">
                    <tr>
                      <th><input type="checkbox" id="selectAllAppts" aria-label="Select all appointments"></th>
                      <th>Date/Time</th>
                      <th>Patient</th>
                      <th>Service</th>
                      <th>Status</th>
                      <th>Notes</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="doctor-appointments-tbody-today">
                    <tr><td colspan="6" class="text-center text-muted">Loading appointments...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
            <div class="tab-pane fade" id="upcoming" role="tabpanel">
              <div class="table-responsive mb-3">
                <table class="table table-hover align-middle" id="doctor-appointments-table-upcoming">
                  <thead class="table-light sticky-top">
                    <tr>
                      <th>Date/Time</th>
                      <th>Patient</th>
                      <th>Service</th>
                      <th>Status</th>
                      <th>Notes</th>
                      <th>Actions</th>
                    </tr>
                  </thead>
                  <tbody id="doctor-appointments-tbody-upcoming">
                    <tr><td colspan="6" class="text-center text-muted">Loading appointments...</td></tr>
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
        <div id="calendarViewContainer" class="d-none">
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5><i class="fa-solid fa-calendar-days me-2"></i>Calendar View</h5>
            <button class="btn btn-outline-secondary" id="backToTableViewBtn">
              <i class="fa-solid fa-table"></i> Back to Table
            </button>
        </div>
          <div class="card p-3">
            <div id="doctorCalendar" style="min-height: 500px;"></div>
      </div>
        </div>
      </div>
      <!-- View Appointment Modal -->
      <div class="modal fade" id="viewAppointmentModal" tabindex="-1" aria-labelledby="viewAppointmentModalLabel" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog">
          <div class="modal-content">
            <div class="modal-header bg-info text-white">
              <h5 class="modal-title" id="viewAppointmentModalLabel"><i class="fa-solid fa-eye me-2"></i>Appointment Details</h5>
              <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="viewAppointmentBody">
              <!-- Content will be loaded here -->
            </div>
            <div class="modal-footer">
              <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
      </div>
      <!-- Reject Appointment Modal -->
      <div class="modal fade" id="rejectAppointmentModal" tabindex="-1" aria-labelledby="rejectAppointmentModalLabel" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog">
          <div class="modal-content">
            <form id="rejectAppointmentForm">
              <div class="modal-header bg-danger text-white">
                <h5 class="modal-title" id="rejectAppointmentModalLabel"><i class="fa-solid fa-xmark me-2"></i>Reject Appointment</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <input type="hidden" id="rejectAppointmentId">
                <div class="mb-3">
                  <label for="rejectReason" class="form-label">Reason (optional)</label>
                  <textarea class="form-control" id="rejectReason" rows="2" maxlength="200" placeholder="Enter reason for rejection"></textarea>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-danger">Reject</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <!-- Write Prescription Modal -->
      <div class="modal fade" id="writePrescriptionModal" tabindex="-1" aria-labelledby="writePrescriptionModalLabel" aria-hidden="true" data-bs-backdrop="static">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <form id="writePrescriptionForm">
              <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="writePrescriptionModalLabel"><i class="fa-solid fa-prescription-bottle-medical me-2"></i>Write Prescription</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <input type="hidden" id="prescriptionAppointmentId">
                <input type="hidden" id="prescriptionPatientId">
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label class="form-label">Patient</label>
                      <div class="form-control-plaintext" id="prescriptionPatientName"></div>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="prescriptionDiagnosis" class="form-label">Diagnosis *</label>
                      <textarea class="form-control" id="prescriptionDiagnosis" rows="2" required placeholder="Enter diagnosis"></textarea>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="prescriptionMedication" class="form-label">Medication *</label>
                      <textarea class="form-control" id="prescriptionMedication" rows="2" required placeholder="Enter medication details"></textarea>
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="prescriptionInstructions" class="form-label">Instructions</label>
                      <textarea class="form-control" id="prescriptionInstructions" rows="2" placeholder="Enter dosage instructions"></textarea>
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="prescriptionDuration" class="form-label">Duration</label>
                      <input type="text" class="form-control" id="prescriptionDuration" placeholder="e.g., 7 days, 2 weeks">
                    </div>
                  </div>
                </div>
                <div class="row">
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="prescriptionRefills" class="form-label">Refills</label>
                      <input type="text" class="form-control" id="prescriptionRefills" placeholder="e.g., 2 refills">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <div class="mb-3">
                      <label for="prescriptionNotes" class="form-label">Notes</label>
                      <textarea class="form-control" id="prescriptionNotes" rows="2" placeholder="Additional notes"></textarea>
                    </div>
                  </div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Save Prescription</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <!-- Upload Lab Results Modal -->
      <div class="modal fade" id="uploadLabModal" tabindex="-1" aria-labelledby="uploadLabModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg">
          <div class="modal-content">
            <form id="uploadLabForm">
              <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="uploadLabModalLabel"><i class="fa-solid fa-flask me-2"></i>Upload Lab Results</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="mb-3">
                  <label for="labPatient" class="form-label">Patient</label>
                  <select class="form-select" id="labPatient" required>
                    <option value="">Select patient</option>
                  </select>
                </div>
                <div class="mb-3">
                  <label for="labTestType" class="form-label">Test Type</label>
                  <input type="text" class="form-control" id="labTestType" placeholder="e.g., Blood Test, Urine Analysis" required>
                </div>
                <div class="mb-3">
                  <label for="labResults" class="form-label">Results</label>
                  <textarea class="form-control" id="labResults" rows="4" placeholder="Enter lab results details..." required></textarea>
                </div>
                <div class="mb-3">
                  <label for="labDate" class="form-label">Test Date</label>
                  <input type="date" class="form-control" id="labDate" required>
                </div>
                <div class="mb-3">
                  <label for="labFile" class="form-label">Upload File (Optional)</label>
                  <input type="file" class="form-control" id="labFile" accept=".pdf,.doc,.docx,.jpg,.jpeg,.png">
                  <div class="form-text">Supported formats: PDF, DOC, DOCX, JPG, PNG</div>
                </div>
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary">Upload Results</button>
              </div>
            </form>
          </div>
        </div>
      </div>
      <!-- Toasts -->
      <div class="position-fixed bottom-0 end-0 p-3" style="z-index: 3000">
        <div id="docApptToast" class="toast align-items-center text-bg-success border-0" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body" id="docApptToastMsg">Action successful!</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        </div>
        <div id="docApptErrorToast" class="toast align-items-center text-bg-danger border-0" role="alert" aria-live="assertive" aria-atomic="true">
          <div class="d-flex">
            <div class="toast-body" id="docApptErrorToastMsg">Error.</div>
            <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
          </div>
        </div>
      </div>
      <!-- Bulk Actions Bar -->
      <div id="bulkActionsBar" class="d-none position-fixed bottom-0 start-0 end-0 bg-light border-top shadow-sm p-3 d-flex justify-content-center gap-2" style="z-index:4000;">
        <button class="btn btn-success" id="bulkApproveBtn"><i class="fa-solid fa-check"></i> Approve</button>
        <button class="btn btn-danger" id="bulkRejectBtn"><i class="fa-solid fa-xmark"></i> Reject</button>
        <button class="btn btn-info" id="bulkCompleteBtn"><i class="fa-solid fa-circle-check"></i> Mark as Completed</button>
        <span id="bulkCount" class="ms-3 text-muted"></span>
      </div>
      <div class="d-flex gap-2 justify-content-center flex-wrap mt-3 mb-2">
        <button class="btn btn-outline-primary btn-lg-custom" id="uploadLabBtn">Upload Lab Results</button>
        <button class="btn btn-outline-secondary btn-lg-custom" onclick="goBack()">Back</button>
      </div>
    </div>
  </main>
  <footer class="text-center py-3 bg-light mt-4 shadow-sm">
    <p class="mb-0">&copy; 2025 Alisay Medical Center</p>
  </footer>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-firestore-compat.js"></script>
  <!-- Your JS files -->
  <script src="assets/js/main.js"></script>
  <script src="assets/js/auth.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/js/all.min.js"></script>
  <script>
    function goBack() {
      if (window.history.length > 1) {
        window.history.back();
      } else {
        window.location.href = 'login.html';
      }
    }
    function logout() {
      firebase.auth().signOut().then(() => {
        window.location.href = 'login.html';
      });
    }
    document.addEventListener('DOMContentLoaded', function() {
      var logoutBtn = document.getElementById('logoutBtn');
      if (logoutBtn) {
        logoutBtn.onclick = function() {
          alert('Logout button clicked!');
          firebase.auth().signOut().then(() => {
            window.location.href = 'login.html';
          });
        };
      }
    });
    // --- Doctor Appointments Logic ---
    const apptTbodyToday = document.getElementById('doctor-appointments-tbody-today');
    const apptTbodyUpcoming = document.getElementById('doctor-appointments-tbody-upcoming');
    const viewModal = new bootstrap.Modal(document.getElementById('viewAppointmentModal'));
    const rejectModal = new bootstrap.Modal(document.getElementById('rejectAppointmentModal'));
    const rejectForm = document.getElementById('rejectAppointmentForm');
    const rejectIdInput = document.getElementById('rejectAppointmentId');
    const rejectReasonInput = document.getElementById('rejectReason');
    const statusFilterSelect = document.getElementById('statusFilter');
    const searchInput = document.getElementById('searchInput');
    const apptTabs = new bootstrap.Tab(document.getElementById('apptTabs'));
    const selectAllApptsCheckbox = document.getElementById('selectAllAppts');
    const bulkActionsBar = document.getElementById('bulkActionsBar');
    const bulkApproveBtn = document.getElementById('bulkApproveBtn');
    const bulkRejectBtn = document.getElementById('bulkRejectBtn');
    const bulkCompleteBtn = document.getElementById('bulkCompleteBtn');
    const bulkCountSpan = document.getElementById('bulkCount');
    const calendarViewBtn = document.getElementById('calendarViewBtn');
    const tableViewContainer = document.getElementById('tableViewContainer');
    const calendarViewContainer = document.getElementById('calendarViewContainer');
    let doctorCalendar = null;
    calendarViewBtn.addEventListener('click', function() {
      if (calendarViewContainer.classList.contains('d-none')) {
        tableViewContainer.classList.add('d-none');
        calendarViewContainer.classList.remove('d-none');
        calendarViewBtn.innerHTML = '<i class="fa-solid fa-table"></i> Table View';
        if (!doctorCalendar) renderDoctorCalendar();
      } else {
        calendarViewContainer.classList.add('d-none');
        tableViewContainer.classList.remove('d-none');
        calendarViewBtn.innerHTML = '<i class="fa-solid fa-calendar-days"></i> Calendar View';
      }
    });

    // Back to table view button
    document.getElementById('backToTableViewBtn').addEventListener('click', function() {
      calendarViewContainer.classList.add('d-none');
      tableViewContainer.classList.remove('d-none');
      calendarViewBtn.innerHTML = '<i class="fa-solid fa-calendar-days"></i> Calendar View';
    });
    function renderDoctorCalendar() {
      const calendarEl = document.getElementById('doctorCalendar');
      if (!calendarEl) return;
      
      doctorCalendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
          left: 'prev,next today',
          center: 'title',
          right: 'dayGridMonth,timeGridWeek,timeGridDay'
        },
        height: 'auto',
        themeSystem: 'bootstrap5',
        dayMaxEvents: true,
        eventClick: function(info) {
          // Show appointment details when clicked
          const appointmentId = info.event.id;
          if (appointmentId) {
            onViewAppointment({ currentTarget: { getAttribute: () => appointmentId } });
          }
        },
        eventDidMount: function(info) {
          // Add tooltips to events
          const event = info.event;
          const status = event.extendedProps.status;
          let color = '#6c757d'; // default gray
          
          switch(status) {
            case 'pending': color = '#ffc107'; break; // warning yellow
            case 'approved': color = '#198754'; break; // success green
            case 'rejected': color = '#dc3545'; break; // danger red
            case 'completed': color = '#0dcaf0'; break; // info blue
          }
          
          info.el.style.backgroundColor = color;
          info.el.style.borderColor = color;
          
          // Add tooltip
          const tooltip = new bootstrap.Tooltip(info.el, {
            title: `${event.title}\nStatus: ${status}\nTime: ${event.start.toLocaleTimeString()}`,
            placement: 'top',
            trigger: 'hover',
            container: 'body'
          });
        },
        events: async function(info, successCallback, failureCallback) {
          try {
            const start = info.start;
            const end = info.end;
            
            const snapshot = await firebase.firestore().collection('appointments')
              .where('doctorId', '==', currentDoctor.uid)
              .where('date', '>=', firebase.firestore.Timestamp.fromDate(start))
              .where('date', '<', firebase.firestore.Timestamp.fromDate(end))
              .get();
            
            const events = [];
            snapshot.forEach(doc => {
              const data = doc.data();
              const date = data.date ? (data.date.seconds ? new Date(data.date.toDate()) : new Date(data.date)) : new Date();
              
              events.push({
                id: doc.id,
                title: `${data.patient} - ${data.service}`,
                start: date,
                end: new Date(date.getTime() + 60 * 60 * 1000), // 1 hour duration
                extendedProps: {
                  patient: data.patient,
                  service: data.service,
                  status: data.status,
                  notes: data.notes
                }
              });
            });
            
            successCallback(events);
          } catch (error) {
            console.error('Error loading calendar events:', error);
            failureCallback(error);
          }
        }
      });
      
      doctorCalendar.render();
    }
    async function fetchDoctorCalendarEvents(fetchInfo, successCallback, failureCallback) {
      try {
        const snap = await firebase.firestore().collection('appointments')
          .where('doctorId','==',currentDoctor.uid)
          .get();
        const events = [];
        snap.forEach(doc => {
          const data = doc.data();
          const date = data.date ? (data.date.seconds ? new Date(data.date.toDate()) : new Date(data.date)) : null;
          if (!date) return;
          events.push({
            id: doc.id,
            title: data.patient + (data.service ? ' - ' + data.service : ''),
            start: date,
            status: data.status,
            backgroundColor: undefined // set in eventDidMount
          });
        });
        successCallback(events);
      } catch (err) {
        failureCallback(err);
      }
    }
    function showDocApptToast(msg, isError = false) {
      const toastEl = isError ? document.getElementById('docApptErrorToast') : document.getElementById('docApptToast');
      const toastMsg = isError ? document.getElementById('docApptErrorToastMsg') : document.getElementById('docApptToastMsg');
      toastMsg.textContent = msg;
      const toast = new bootstrap.Toast(toastEl);
      toast.show();
    }
    let currentDoctor = null;
    firebase.auth().onAuthStateChanged(async function(user) {
      if (user) {
        currentDoctor = user;
        loadDoctorAppointments();
      } else {
        window.location.href = 'login.html';
      }
    });

    async function loadDoctorAppointments() {
      try {
        if (!apptTbodyToday || !apptTbodyUpcoming) {
          console.error('Appointment table elements not found');
          return;
        }
        
        console.log('Loading appointments for doctor:', currentDoctor.uid);
        
      apptTbodyToday.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Loading appointments...</td></tr>';
      apptTbodyUpcoming.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Loading appointments...</td></tr>';
        
      const now = new Date();
        
        // First, let's check all appointments to see what's in the database
        const allAppointments = await firebase.firestore().collection('appointments').get();
        console.log('Total appointments in database:', allAppointments.size);
        
        allAppointments.forEach(doc => {
          const data = doc.data();
          console.log('Appointment:', {
            id: doc.id,
            doctorId: data.doctorId,
            currentDoctorId: currentDoctor.uid,
            patient: data.patient,
            date: data.date,
            status: data.status
          });
        });
        
        // TEMPORARY: Show all appointments for debugging
        const todaySnap = await firebase.firestore().collection('appointments').get();
        const upcomingSnap = await firebase.firestore().collection('appointments').get();

        console.log('Today appointments found:', todaySnap.size);
        console.log('Upcoming appointments found:', upcomingSnap.size);

      if (todaySnap.empty && upcomingSnap.empty) {
        apptTbodyToday.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No appointments found.</td></tr>';
        apptTbodyUpcoming.innerHTML = '<tr><td colspan="6" class="text-center text-muted">No appointments found.</td></tr>';
        return;
      }

      apptTbodyToday.innerHTML = '';
      apptTbodyUpcoming.innerHTML = '';

        // Filter appointments by date after fetching
        const todayAppointments = [];
        const upcomingAppointments = [];

      todaySnap.forEach(doc => {
        const data = doc.data();
        const date = data.date ? (data.date.seconds ? new Date(data.date.toDate()) : new Date(data.date)) : '';
          if (date && date >= now) {
            todayAppointments.push({ doc, data, date });
          }
        });

        upcomingSnap.forEach(doc => {
          const data = doc.data();
          const date = data.date ? (data.date.seconds ? new Date(data.date.toDate()) : new Date(data.date)) : '';
          if (date && date > now) {
            upcomingAppointments.push({ doc, data, date });
          }
        });

        // Sort appointments by date
        todayAppointments.sort((a, b) => a.date - b.date);
        upcomingAppointments.sort((a, b) => a.date - b.date);

        todayAppointments.forEach(({ doc, data, date }) => {
        if (date && date < now) return; // Only show today/future
        const dateStr = date ? date.toLocaleString() : '';
        const patient = data.patient || '';
        const service = data.service || '';
        const status = data.status || '';
        const notes = data.notes || '';
        const reason = data.rejectionReason || '';
        let statusClass = 'secondary';
        if (status==='pending') statusClass = 'warning';
        else if (status==='approved') statusClass = 'success';
        else if (status==='rejected') statusClass = 'danger';
        else if (status==='completed') statusClass = 'info';

        // Highlight soon appointments (e.g., within 1 hour)
        const appointmentTime = new Date(date);
        const timeDiff = appointmentTime - now;
        const isSoon = timeDiff > 0 && timeDiff < 3600000; // More than 0 seconds and less than 1 hour

        apptTbodyToday.innerHTML += `<tr class='${isSoon ? 'table-warning' : ''}'>
          <td><input type="checkbox" class="appt-checkbox" data-id='${doc.id}'></td>
          <td>${dateStr}</td>
          <td>${patient}</td>
          <td>${service}</td>
          <td><span class="badge bg-${statusClass} text-capitalize">${status}</span>${status==='rejected'&&reason?`<br><small class='text-danger'>${reason}</small>`:''}</td>
          <td>${notes}</td>
          <td>
              <div class="action-buttons">
                <button class='btn btn-sm btn-outline-info view-appt-btn' data-id='${doc.id}' title="View Details"><i class='fa-solid fa-eye'></i></button>
                ${status==='pending'?`<button class='btn btn-sm btn-outline-success approve-appt-btn' data-id='${doc.id}' title="Approve"><i class='fa-solid fa-check'></i></button>`:''}
                ${status==='pending'?`<button class='btn btn-sm btn-outline-danger reject-appt-btn' data-id='${doc.id}' title="Reject"><i class='fa-solid fa-xmark'></i></button>`:''}
                ${status==='approved'?`<button class='btn btn-sm btn-outline-info complete-appt-btn' data-id='${doc.id}' title="Mark Complete"><i class='fa-solid fa-check-double'></i></button>`:''}
                <button class='btn btn-sm btn-outline-primary write-prescription-btn' data-id='${doc.id}' title="Write Prescription"><i class='fa-solid fa-prescription-bottle-medical'></i></button>
              </div>
          </td>
        </tr>`;
      });

        upcomingAppointments.forEach(({ doc, data, date }) => {
        if (date && date < now) return; // Only show today/future
        const dateStr = date ? date.toLocaleString() : '';
        const patient = data.patient || '';
        const service = data.service || '';
        const status = data.status || '';
        const notes = data.notes || '';
        const reason = data.rejectionReason || '';
        let statusClass = 'secondary';
        if (status==='pending') statusClass = 'warning';
        else if (status==='approved') statusClass = 'success';
        else if (status==='rejected') statusClass = 'danger';
        else if (status==='completed') statusClass = 'info';

        // Highlight soon appointments (e.g., within 1 hour)
        const appointmentTime = new Date(date);
        const timeDiff = appointmentTime - now;
        const isSoon = timeDiff > 0 && timeDiff < 3600000; // More than 0 seconds and less than 1 hour

        apptTbodyUpcoming.innerHTML += `<tr class='${isSoon ? 'table-warning' : ''}'>
          <td>${dateStr}</td>
          <td>${patient}</td>
          <td>${service}</td>
          <td><span class="badge bg-${statusClass} text-capitalize">${status}</span>${status==='rejected'&&reason?`<br><small class='text-danger'>${reason}</small>`:''}</td>
          <td>${notes}</td>
          <td>
              <div class="action-buttons">
                <button class='btn btn-sm btn-outline-info view-appt-btn' data-id='${doc.id}' title="View Details"><i class='fa-solid fa-eye'></i></button>
                ${status==='pending'?`<button class='btn btn-sm btn-outline-success approve-appt-btn' data-id='${doc.id}' title="Approve"><i class='fa-solid fa-check'></i></button>`:''}
                ${status==='pending'?`<button class='btn btn-sm btn-outline-danger reject-appt-btn' data-id='${doc.id}' title="Reject"><i class='fa-solid fa-xmark'></i></button>`:''}
                ${status==='approved'?`<button class='btn btn-sm btn-outline-info complete-appt-btn' data-id='${doc.id}' title="Mark Complete"><i class='fa-solid fa-check-double'></i></button>`:''}
                <button class='btn btn-sm btn-outline-primary write-prescription-btn' data-id='${doc.id}' title="Write Prescription"><i class='fa-solid fa-prescription-bottle-medical'></i></button>
              </div>
          </td>
        </tr>`;
      });

      // Attach listeners
      document.querySelectorAll('.view-appt-btn').forEach(btn=>{
        btn.onclick = onViewAppointment;
      });
      document.querySelectorAll('.approve-appt-btn').forEach(btn=>{
        btn.onclick = onApproveAppointment;
      });
      document.querySelectorAll('.reject-appt-btn').forEach(btn=>{
        btn.onclick = onRejectAppointment;
      });
        document.querySelectorAll('.write-prescription-btn').forEach(btn=>{
          btn.onclick = onWritePrescription;
        });
        document.querySelectorAll('.complete-appt-btn').forEach(btn=>{
          btn.onclick = onCompleteAppointment;
        });
      } catch (err) {
        console.error('Error loading appointments:', err);
        if (apptTbodyToday) apptTbodyToday.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error loading appointments</td></tr>';
        if (apptTbodyUpcoming) apptTbodyUpcoming.innerHTML = '<tr><td colspan="6" class="text-center text-danger">Error loading appointments</td></tr>';
      }
    };

    async function onViewAppointment(e) {
      const apptId = e.currentTarget.getAttribute('data-id');
      const doc = await firebase.firestore().collection('appointments').doc(apptId).get();
      if (!doc.exists) return;
      const data = doc.data();
      let html = `<div class='mb-2'><strong>Date/Time:</strong> ${data.date?new Date(data.date).toLocaleString():''}</div>`;
      html += `<div class='mb-2'><strong>Patient:</strong> ${data.patient||''}</div>`;
      html += `<div class='mb-2'><strong>Service:</strong> ${data.service||''}</div>`;
      html += `<div class='mb-2'><strong>Status:</strong> ${data.status||''}</div>`;
      html += `<div class='mb-2'><strong>Notes:</strong> ${data.notes||''}</div>`;
      if (data.status==='rejected' && data.rejectionReason) html += `<div class='mb-2 text-danger'><strong>Rejection Reason:</strong> ${data.rejectionReason}</div>`;
      if (data.patientEmail) html += `<div class='mb-2'><strong>Email:</strong> ${data.patientEmail}</div>`;
      if (data.patientPhone) html += `<div class='mb-2'><strong>Phone:</strong> ${data.patientPhone}</div>`;
      document.getElementById('viewAppointmentBody').innerHTML = html;
      
      // Close any existing modals first
      const existingModal = bootstrap.Modal.getInstance(document.getElementById('viewAppointmentModal'));
      if (existingModal) {
        existingModal.hide();
        setTimeout(() => {
          const newModal = new bootstrap.Modal(document.getElementById('viewAppointmentModal'));
          newModal.show();
        }, 150);
      } else {
        const viewModal = new bootstrap.Modal(document.getElementById('viewAppointmentModal'));
      viewModal.show();
      }
    }
    async function onApproveAppointment(e) {
      const apptId = e.currentTarget.getAttribute('data-id');
      try {
        await firebase.firestore().collection('appointments').doc(apptId).update({ status: 'approved', rejectionReason: '' });
        showDocApptToast('Appointment approved!');
        loadDoctorAppointments();
      } catch (err) {
        showDocApptToast(err.message||'Error approving appointment.', true);
      }
    }
    function onRejectAppointment(e) {
      const apptId = e.currentTarget.getAttribute('data-id');
      rejectIdInput.value = apptId;
      rejectReasonInput.value = '';
      rejectModal.show();
    }
    
    async function onCompleteAppointment(e) {
      const apptId = e.currentTarget.getAttribute('data-id');
      try {
        await firebase.firestore().collection('appointments').doc(apptId).update({ status: 'completed' });
        showDocApptToast('Appointment marked as completed!');
        loadDoctorAppointments();
      } catch (err) {
        showDocApptToast(err.message||'Error completing appointment.', true);
      }
    }
    
    async function onWritePrescription(e) {
      const apptId = e.currentTarget.getAttribute('data-id');
      const doc = await firebase.firestore().collection('appointments').doc(apptId).get();
      if (!doc.exists) return;
      const data = doc.data();
      
      // Set appointment data in the prescription modal
      document.getElementById('prescriptionAppointmentId').value = apptId;
      document.getElementById('prescriptionPatientName').textContent = data.patient || '';
      document.getElementById('prescriptionPatientId').value = data.userId || '';
      
      // Reset form
      document.getElementById('prescriptionDiagnosis').value = '';
      document.getElementById('prescriptionMedication').value = '';
      document.getElementById('prescriptionInstructions').value = '';
      document.getElementById('prescriptionDuration').value = '';
      document.getElementById('prescriptionRefills').value = '';
      document.getElementById('prescriptionNotes').value = '';
      
      // Show the prescription modal
      const existingPrescriptionModal = bootstrap.Modal.getInstance(document.getElementById('writePrescriptionModal'));
      if (existingPrescriptionModal) {
        existingPrescriptionModal.hide();
        setTimeout(() => {
          const prescriptionModal = new bootstrap.Modal(document.getElementById('writePrescriptionModal'));
          prescriptionModal.show();
        }, 150);
      } else {
        const prescriptionModal = new bootstrap.Modal(document.getElementById('writePrescriptionModal'));
        prescriptionModal.show();
      }
    }
    
    // Handle prescription form submission
    document.getElementById('writePrescriptionForm').onsubmit = async function(e) {
      e.preventDefault();
      
      const appointmentId = document.getElementById('prescriptionAppointmentId').value;
      const patientId = document.getElementById('prescriptionPatientId').value;
      const diagnosis = document.getElementById('prescriptionDiagnosis').value.trim();
      const medication = document.getElementById('prescriptionMedication').value.trim();
      const instructions = document.getElementById('prescriptionInstructions').value.trim();
      const duration = document.getElementById('prescriptionDuration').value.trim();
      const refills = document.getElementById('prescriptionRefills').value.trim();
      const notes = document.getElementById('prescriptionNotes').value.trim();
      
      if (!diagnosis || !medication) {
        showDocApptToast('Please fill in diagnosis and medication.', true);
        return;
      }
      
      try {
        await firebase.firestore().collection('prescriptions').add({
          appointmentId: appointmentId,
          patientId: patientId,
          doctorId: currentDoctor.uid,
          diagnosis: diagnosis,
          medication: medication,
          instructions: instructions,
          duration: duration,
          refills: refills,
          notes: notes,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        
        // Create notification for the patient
        try {
          await firebase.firestore().collection('notifications').add({
            patientId: patientId,
            title: 'New Prescription Available',
            message: `Dr. ${currentDoctor.displayName || currentDoctor.email} has written you a prescription`,
            type: 'prescription',
            read: false,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
          });
        } catch (err) {
          console.error('Error creating patient notification:', err);
        }
        
        showDocApptToast('Prescription saved successfully!');
        
        // Hide the modal
        const prescriptionModal = bootstrap.Modal.getInstance(document.getElementById('writePrescriptionModal'));
        prescriptionModal.hide();
        
      } catch (err) {
        showDocApptToast('Failed to save prescription: ' + err.message, true);
      }
    };
    rejectForm.onsubmit = async function(e) {
      e.preventDefault();
      const apptId = rejectIdInput.value;
      const reason = rejectReasonInput.value.trim();
      try {
        await firebase.firestore().collection('appointments').doc(apptId).update({ status: 'rejected', rejectionReason: reason });
        showDocApptToast('Appointment rejected.');
        rejectModal.hide();
        loadDoctorAppointments();
      } catch (err) {
        showDocApptToast(err.message||'Error rejecting appointment.', true);
      }
    };

    // Filter and Search Logic
    function applyFiltersAndSearch() {
      const selectedStatus = statusFilterSelect.value;
      const searchTerm = searchInput.value.toLowerCase();
      const todayRows = Array.from(apptTbodyToday.children);
      const upcomingRows = Array.from(apptTbodyUpcoming.children);

      todayRows.forEach(row => {
        // Add null checks for cells
        if (!row.cells || row.cells.length < 5) return;
        
        const patientCell = row.cells[2];
        const serviceCell = row.cells[3];
        const statusCell = row.cells[4];
        
        if (!patientCell || !serviceCell || !statusCell) return;
        
        const patientText = patientCell.textContent.toLowerCase(); // Patient is at index 2
        const serviceText = serviceCell.textContent.toLowerCase(); // Service is at index 3
        const statusText = statusCell.textContent.toLowerCase(); // Status is at index 4
        const isVisible = (selectedStatus === '' || statusText.includes(selectedStatus)) &&
                          (patientText.includes(searchTerm) || serviceText.includes(searchTerm));
        row.style.display = isVisible ? '' : 'none';
      });

      upcomingRows.forEach(row => {
        // Add null checks for cells
        if (!row.cells || row.cells.length < 4) return;
        
        const patientCell = row.cells[1];
        const serviceCell = row.cells[2];
        const statusCell = row.cells[3];
        
        if (!patientCell || !serviceCell || !statusCell) return;
        
        const patientText = patientCell.textContent.toLowerCase(); // Patient is at index 1
        const serviceText = serviceCell.textContent.toLowerCase(); // Service is at index 2
        const statusText = statusCell.textContent.toLowerCase(); // Status is at index 3
        const isVisible = (selectedStatus === '' || statusText.includes(selectedStatus)) &&
                          (patientText.includes(searchTerm) || serviceText.includes(searchTerm));
        row.style.display = isVisible ? '' : 'none';
      });
    }

    if (statusFilterSelect) {
    statusFilterSelect.addEventListener('change', applyFiltersAndSearch);
    }
    if (searchInput) {
    searchInput.addEventListener('input', applyFiltersAndSearch);
    }

    // Initial load and tab logic
    loadDoctorAppointments();
    apptTabs.show(); // Ensure the first tab is active

    // Handle tab changes
    document.getElementById('apptTabs').addEventListener('shown.bs.tab', function (event) {
      const target = event.target;
      if (target.id === 'today-tab') {
        apptTbodyToday.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Loading appointments...</td></tr>';
        loadDoctorAppointments();
      } else if (target.id === 'upcoming-tab') {
        apptTbodyUpcoming.innerHTML = '<tr><td colspan="6" class="text-center text-muted">Loading appointments...</td></tr>';
        loadDoctorAppointments();
      }
    });

    // Bulk Actions Logic
    function updateBulkActions() {
      const selectedAppts = Array.from(apptTbodyToday.querySelectorAll('.appt-checkbox:checked')).map(cb => cb.getAttribute('data-id'));
      bulkApproveBtn.disabled = selectedAppts.length === 0;
      bulkRejectBtn.disabled = selectedAppts.length === 0;
      bulkCompleteBtn.disabled = selectedAppts.length === 0;
      bulkCountSpan.textContent = `${selectedAppts.length} selected`;
      bulkActionsBar.classList.remove('d-none');
    }

    selectAllApptsCheckbox.addEventListener('change', function() {
      apptTbodyToday.querySelectorAll('.appt-checkbox').forEach(cb => {
        cb.checked = this.checked;
      });
      apptTbodyUpcoming.querySelectorAll('.appt-checkbox').forEach(cb => {
        cb.checked = this.checked;
      });
      updateBulkActions();
    });

    apptTbodyToday.addEventListener('change', updateBulkActions);
    apptTbodyUpcoming.addEventListener('change', updateBulkActions);

    bulkApproveBtn.addEventListener('click', async function() {
      const selectedApptIds = Array.from(apptTbodyToday.querySelectorAll('.appt-checkbox:checked')).map(cb => cb.getAttribute('data-id'));
      if (selectedApptIds.length === 0) {
        showDocApptToast('Please select appointments to approve.', true);
        return;
      }
      if (!confirm(`Are you sure you want to approve ${selectedApptIds.length} appointment(s)? This action cannot be undone.`)) {
        return;
      }
      try {
        await Promise.all(selectedApptIds.map(id =>
          firebase.firestore().collection('appointments').doc(id).update({ status: 'approved', rejectionReason: '' })
        ));
        showDocApptToast(`${selectedApptIds.length} appointments approved.`);
        loadDoctorAppointments();
      } catch (err) {
        showDocApptToast(err.message||'Error approving appointments.', true);
      }
    });

    bulkRejectBtn.addEventListener('click', async function() {
      const selectedApptIds = Array.from(apptTbodyToday.querySelectorAll('.appt-checkbox:checked')).map(cb => cb.getAttribute('data-id'));
      if (selectedApptIds.length === 0) {
        showDocApptToast('Please select appointments to reject.', true);
        return;
      }
      if (!confirm(`Are you sure you want to reject ${selectedApptIds.length} appointment(s)? This action cannot be undone.`)) {
        return;
      }
      try {
        await Promise.all(selectedApptIds.map(id => {
          const rejectReason = prompt('Enter rejection reason for all selected appointments:');
          return firebase.firestore().collection('appointments').doc(id).update({ status: 'rejected', rejectionReason: rejectReason });
        }));
        showDocApptToast(`${selectedApptIds.length} appointments rejected.`);
        loadDoctorAppointments();
      } catch (err) {
        showDocApptToast(err.message||'Error rejecting appointments.', true);
      }
    });

    bulkCompleteBtn.addEventListener('click', async function() {
      const selectedApptIds = Array.from(apptTbodyToday.querySelectorAll('.appt-checkbox:checked')).map(cb => cb.getAttribute('data-id'));
      if (selectedApptIds.length === 0) {
        showDocApptToast('Please select appointments to mark as completed.', true);
        return;
      }
      if (!confirm(`Are you sure you want to mark ${selectedApptIds.length} appointment(s) as completed? This action cannot be undone.`)) {
        return;
      }
      try {
        await Promise.all(selectedApptIds.map(id =>
          firebase.firestore().collection('appointments').doc(id).update({ status: 'completed' })
        ));
        showDocApptToast(`${selectedApptIds.length} appointments marked as completed.`);
        loadDoctorAppointments();
      } catch (err) {
        showDocApptToast(err.message||'Error marking appointments as completed.', true);
      }
    });

    // Handle bulk actions visibility
    document.querySelectorAll('.appt-checkbox').forEach(cb => {
      cb.addEventListener('change', updateBulkActions);
    });

    // Hide bulk actions bar initially
    bulkActionsBar.classList.add('d-none');

    // Upload Lab Results logic
    const uploadLabBtn = document.getElementById('uploadLabBtn');
    const uploadLabModal = new bootstrap.Modal(document.getElementById('uploadLabModal'));
    const uploadLabForm = document.getElementById('uploadLabForm');
    const labPatientSelect = document.getElementById('labPatient');
    const labTestTypeInput = document.getElementById('labTestType');
    const labResultsTextarea = document.getElementById('labResults');
    const labDateInput = document.getElementById('labDate');
    const labFileInput = document.getElementById('labFile');
    const exportCsvBtn = document.getElementById('exportCsvBtn');

    // Populate patient dropdown for lab results
    async function populateLabPatientDropdown() {
      labPatientSelect.innerHTML = '<option value="">Loading patients...</option>';
      try {
        const snap = await firebase.firestore().collection('patients').where('doctorId', '==', currentDoctor.uid).get();
        let options = '<option value="">Select patient</option>';
      snap.forEach(doc => {
          const data = doc.data();
          options += `<option value="${doc.id}">${data.firstName} ${data.lastName} (${data.phone})</option>`;
        });
        labPatientSelect.innerHTML = options;
      } catch (err) {
        console.error('Error populating patient dropdown:', err);
        labPatientSelect.innerHTML = '<option value="">Error loading patients</option>';
      }
    }

    // Upload Lab Results logic
    uploadLabBtn.onclick = async function() {
      await populateLabPatientDropdown(); // Populate patient dropdown
      uploadLabForm.reset();
      uploadLabModal.show();
    };
    uploadLabForm.onsubmit = async function(e) {
      e.preventDefault();
      const patientId = labPatientSelect.value;
      const testType = labTestTypeInput.value;
      const results = labResultsTextarea.value;
      const testDate = labDateInput.value;
      const file = labFileInput.files[0];

      if (!patientId || !testType || !testDate) {
        showDocApptToast('Please select a patient, test type, and test date.', true);
        return;
      }

      try {
        const labResultRef = firebase.storage().ref(`labResults/${patientId}/${testType}-${testDate}.pdf`); // Assuming PDF for now
        if (file) {
          await labResultRef.put(file);
        }
        const fileUrl = file ? await labResultRef.getDownloadURL() : null;

        await firebase.firestore().collection('labResults').add({
          patientId: patientId,
          testType: testType,
          results: results,
          testDate: firebase.firestore.Timestamp.fromDate(new Date(testDate)),
          fileUrl: fileUrl,
          createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });

        showDocApptToast('Lab result uploaded!');
        uploadLabModal.hide();
        loadDoctorAppointments(); // Refresh appointments to show new lab result
      } catch (err) {
        showDocApptToast(err.message||'Error uploading lab result.', true);
      }
    };
    // Export to CSV logic
    exportCsvBtn.onclick = function() {
      // Gather visible rows from the current table view
      let rows = [];
      const activeTab = document.querySelector('.tab-pane.active');
      const tbody = activeTab ? activeTab.querySelector('tbody') : null;
      if (tbody) {
        Array.from(tbody.children).forEach(row => {
          if (row.style.display === 'none') return;
          const cells = Array.from(row.children).map(td => td.textContent.trim());
          rows.push(cells);
        });
      }
      if (rows.length === 0) {
        showDocApptToast('No appointments to export.', true);
        return;
      }
      
      // Create CSV content with headers
      const headers = ['Date', 'Patient', 'Service', 'Status', 'Notes'];
      const csvContent = [
        headers.join(','),
        ...rows.map(row => row.slice(0, 5).map(cell => `"${cell.replace(/"/g, '""')}"`).join(','))
      ].join('\n');
      
      // Download CSV file
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const link = document.createElement('a');
      const url = URL.createObjectURL(blob);
      link.setAttribute('href', url);
      link.setAttribute('download', `appointments_${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
      showDocApptToast('Appointments exported successfully!');
    };
  </script>
</body>
</html> 
